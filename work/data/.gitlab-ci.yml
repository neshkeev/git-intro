stages:
  - build
  - test
  - deploy

build-job:
  stage: build
  tags:
    - docker
  script:
    - docker build -t echo .

unit-test-job:
  stage: test
  tags:
    - docker
  script:
    - docker run echo python tests.py

deploy-job:
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  tags:
    - docker
  script:
    - docker ps --filter='expose=8000' --format "{{.ID}}" | while read container; do docker stop "$container" ; done
    - docker run -d -p 8000:8000 echo

